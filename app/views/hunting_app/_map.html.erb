<% content_for :head do %>
<script type="text/javascript">
var g_memberLocations = null;
var g_huntingLocations = null;
function showMap() {
  if (typeof(g_map) == 'undefined') {
    var mapOptions = {
      showCenterMarker: false,
      mapTypeControl: false,
      streetViewControl: false,
      borderFillColor: '#cccccc',
      center: { lat: <%=@hunting_plot.location_coordinates.y()%>, lng: <%=@hunting_plot.location_coordinates.x()%> },
  <%
  if !@hunting_plot.boundary.nil?
      view_window = rgeo_get_bounds(@hunting_plot.boundary)
  %>
      view_window: { sw: { lat: <%= view_window[:sw][:lat] %>, lng: <%= view_window[:sw][:lng] %> }, ne: { lat: <%= view_window[:ne][:lat] %>, lng: <%= view_window[:ne][:lng] %> } },
      boundary: parseWKTPolygon('<%=@hunting_plot.boundary.to_s%>'),
  <%
  end
  %>
      zoom: 12
    };
    try {
      g_map = new MapsHelper('map-canvas', mapOptions);
    }
    catch (e) {
      alert("The following error occurred: " + e);
    }
    updateHuntingLocationStatus();
    PlotMapHelper.showLocations();
    PlotMapHelper.showMembers();
    PlotMapHelper.showWindConditions();
    $('#map-options-panel ul li input').change(
      function(event) {
        var isChecked = $(this).is(':checked');
        switch ($(this).attr('name')) {
          case 'satellite-checkbox':
          {
            g_map.setMapType( isChecked ? MapsHelper.MapTypes.Satellite : MapsHelper.MapTypes.Roadmap );
            break;
          }
          case 'members-checkbox':
          {
            if (isChecked) {
              PlotMapHelper.showMembers();
            }
            else {
              PlotMapHelper.hideMembers();
            }
            break;
          }
          case 'stands-checkbox':
          {
            if (isChecked) {
              PlotMapHelper.showLocations();
            }
            else {
              PlotMapHelper.hideLocations();
            }
            break;
          }
          case 'wind-forecast-checkbox':
          {
            if (isChecked) {
              PlotMapHelper.showWindConditions();
            }
            else {
              PlotMapHelper.hideWindConditions();
            }
            break;
          }
        }
      }
    );
  }
}
var PlotMapHelper = function() {
  var plotMembersMarkerTag = 'plot-members';
  var plotLocationsMarkerTag = 'hunting-locations';
  this.showMembers = function() {
    $.each(
      g_memberLocations,
      function(index, member_location) {
        g_map.addMarker(
          {
            title: member_location.first_name +  " " + member_location.last_name,
            coordinates: member_location.location_coordinates,
            icon: new google.maps.MarkerImage('<%= asset_url('user_pin.png') %>', null, null, null, new google.maps.Size(24,24)),
            zIndex: 3,
            infoWindowContent: member_location.first_name + '&nbsp;' + member_location.last_name + '<br/>' + member_location.location_name
          },
          plotMembersMarkerTag
        );
      }
    );
  }
  this.hideMembers = function() {
    g_map.clearMarkers(plotMembersMarkerTag);
  }
  this.showLocations = function() {
    $.each(
      g_huntingLocations,
      function(index, hunting_location) {
        if (hunting_location.mapMarker == null) {
          var markerIcon = MapIcons.HuntingLocationAvailable;
          if (isDefined(hunting_location.status)) {
            switch (hunting_location.status) {
              case HuntingLocationStatus.Available:
                markerIcon = MapIcons.HuntingLocationAvailable;
                break;
              case HuntingLocationStatus.Occupied:
                markerIcon = MapIcons.HuntingLocationOccupied;
                break;
              case HuntingLocationStatus.Reserved:
                markerIcon = MapIcons.HuntingLocationReserved;
                break;
            }
          }
          hunting_location.mapMarker = g_map.addMarker(
            {
              title: hunting_location.name,
              coordinates: hunting_location.coordinates,
              icon: markerIcon,
              zIndex: 2
            },
            plotLocationsMarkerTag
          );
        }
        else {
          hunting_location.mapMarker.show();
        }
      }
    );
  }
  this.hideLocations = function() {
    $.each(
      g_huntingLocations,
      function(index, hunting_location) {
        if (hunting_location.mapMarker != null) hunting_location.mapMarker.hide();
      }
    );
  }
  this.showWindConditions = function() {
    var svgDoc = $("#windIndicatorSvg");
    var windSpeedNode = svgDoc.find("#windSpeed");
    var windDirectionNode = svgDoc.find("#windDirection");
    windSpeedNode.text(g_windForecast.wind_mph);
    windDirectionNode.attr("transform", "rotate(" + g_windForecast.wind_degrees + " 35 35)");
    $('#map-wind-indicator').show();
  }
  this.hideWindConditions = function() {
    $('#map-wind-indicator').hide();
  }
  return this;
}();
var g_huntingLocations = <%==
    @hunting_plot.locations.collect do |hunting_location|
      {
        id: hunting_location.id,
        name: hunting_location.name,
        coordinates: {
          lat: hunting_location.coordinates.y(),
          lng: hunting_location.coordinates.x()
        }
      }
    end.to_json
  %>;
var g_huntingLocationReservations = <%==
  @hunting_location_schedules.collect do |hunting_location_schedule|
      {
        location_id: hunting_location_schedule.hunting_location_id,
        created_by: hunting_location_schedule.created_by.get_display_name,
        start_date_time: hunting_location_schedule.start_date_time,
        end_date_time: hunting_location_schedule.end_date_time,
      }
    end.to_json
  %>;
var g_windForecast = <%==
  hourly_forecast = get_hourly_weather_forecast(@hunting_plot)
  forecast = {
    wind_dir: hourly_forecast[:forecast][0]['wdir']['dir'],
    wind_degrees: hourly_forecast[:forecast][0]['wdir']['degrees'],
    wind_mph: hourly_forecast[:forecast][0]['wspd']['english']
  }
  forecast.to_json %>;
var HuntingLocationStatus = { Available: 1, Occupied: 2, Reserved: 3 };
function updateHuntingLocationStatus() {
  $.each(
    g_huntingLocations,
    function(index, hunting_location) {
      for (var i = 0; i < g_memberLocations.length; i++) {
        if (g_memberLocations[i].location_id == hunting_location.id) {
          updateHuntingLocationStatus(hunting_location, HuntingLocationStatus.Occupied);
          return;
        }
      }
      for (var i = 0; i < g_huntingLocationReservations.length; i++) {
        if (g_huntingLocationReservations[i].location_id == hunting_location.id) {
          updateHuntingLocationStatus(hunting_location, HuntingLocationStatus.Reserved);
          return;
        }
      }
    }
  );
  function updateHuntingLocationStatus(hunting_location, newStatus) {
    var statusChanged = (!isDefined(hunting_location.status) || (hunting_location.status != newStatus));
    hunting_location.status = newStatus;
    if (isDefined(hunting_location.mapMarker) && (statusChanged)) {
      switch (newStatus) {
        case HuntingLocationStatus.Available:
          hunting_location.mapMarker.setIcon(MapIcons.HuntingLocationAvailable);
          break;
        case HuntingLocationStatus.Occupied:
          hunting_location.mapMarker.setIcon(MapIcons.HuntingLocationOccupied);
          break;
        case HuntingLocationStatus.Reserved:
          hunting_location.mapMarker.setIcon(MapIcons.HuntingLocationReserved);
          break;
      }
    }
  }
}
</script>
<% end %>
<% content_for :panels do %>
<div data-role="panel" data-display="overlay" data-position="right" id="map-options-panel" class="right-align-panel">
  <ul data-role="listview">
    <li>
      <label>
        <input name="satellite-checkbox" id="satellite-checkbox" type="checkbox" data-role="flipswitch"> Satellite Imagery
      </label>
    </li>
    <li>
      <label>
        <input name="members-checkbox" id="members-checkbox" type="checkbox" data-role="flipswitch" checked="true"> Members <%= image_tag 'user_pin.png', size:'24x24' %>
      </label>
    </li>
    <li>
      <label>
        <input name="stands-checkbox" id="stands-checkbox" type="checkbox" data-role="flipswitch" checked="true"> Stands <%= image_tag 'hunting_plot_location.png', size:'16x16' %>
      </label>
    </li>
    <li>
      <label>
        <input name="wind-forecast-checkbox" id="wind-forecast-checkbox" type="checkbox" data-role="flipswitch" checked="true"> Wind Conditions
      </label>
    </li>
  </ul>
  <a href="#header" data-rel="close" class="ui-btn ui-icon-delete ui-btn-icon-left" id="map-options-close-button">Close</a>
</div>
<% end %>
<div id="map-canvas" style="width:100%;height:100%;">Loading, please wait...</div>
<div id="map-options-popup" style="position:absolute; right: 0px;top: 100px;">
  <a class="ui-btn ui-btn-inline" href="#map-options-panel" title="Display Options" data-role="button"><%= image_tag 'layers.svg' %></a>
</div>
<div id="map-wind-indicator" style="position: absolute; right: 10px; bottom: 25px; display:none; background-color:white; text-align: center;">
  Wind<br/>
  <svg id="windIndicatorSvg" xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
    <defs>
      <marker id="Arrow" markerWidth="10" markerHeight="10" viewBox="-6 -6 12 12" refX="-2" refY="0" markerUnits="strokeWidth" orient="auto">
        <polygon points="-4,0 -5,5 5,0 -5,-5" fill="black" stroke="none" stroke-width="1px"/>
      </marker>
    </defs>
    <circle id="mycircle" fill="none" stroke="black" cx="35" cy="35" r="25" stroke-width="3px" />
    <text id="windSpeed" x="35" y="42" fill="black" font-size="16" font-weight="bold" text-anchor="middle">12</text>
    <line id="windDirection" x1="35" y1="8" x2="35" y2="9" stroke="black" stroke-width="2px" marker-end="url(#Arrow)" transform="rotate(0 35 35)" />
  </svg>
</div>
